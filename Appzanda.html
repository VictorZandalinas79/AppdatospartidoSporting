<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Data Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --background-color: #2c3e50;
            --text-color: #ecf0f1;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: var(--background-color);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
        }

        .videomarcador {
    background-color: #34495e; /* Fondo oscuro para buen contraste */
    color: #ecf0f1; /* Color claro para el texto para mejorar la visibilidad */
    padding: 20px;
    border-radius: 10px; /* Bordes redondeados para un look moderno */
    margin-bottom: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5); /* Sombra para dar profundidad */
    border: 1px solid #2c3e50; /* Borde sutil */
    text-shadow: 1px 1px 2px black; /* Sombra en el texto para mejorar la legibilidad */
    background-image: linear-gradient(to right, #4a69bd, #6a89cc); /* Gradiente para un look m√°s vibrante */
}


        .timer-controls button {
            background-color: var(--primary-color);
            color: var(--text-color);
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .timer-controls button:hover {
            background-color: #2980b9;
        }

        .counter-button {
    background-color: var(--secondary-color);
    color: black;  /* Establece el texto a negro directamente */
    border: none;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
    transition: background-color 0.3s;
}

        .counter-button:hover {
            background-color: #27ae60;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
        }

        th, td {
            padding: 12px;
            text-align: center;
            background-color: #34495e;
        }

        th {
            background-color: var(--primary-color);
            color: var(--text-color);
        }

        .status-button {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .status-button.active {
            background-color: var(--primary-color);
        }

        #generalTimer {
    font-family: 'Roboto Mono', monospace;
    font-size: 3rem;
    color: #3498db;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    padding: 10px 20px;
    border-radius: 5px;
    border: 1px solid #3498db;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    text-align: center; /* Asegura que el texto dentro del cron√≥metro est√© centrado */
    min-width: 250px; /* Ancho m√≠nimo para estabilidad visual */
}



        .chart-container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
        }
    </style>
</head>

<body class="p-6">
    <div class="max-w-4xl mx-auto bg-gray-800 p-6 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold mb-6 text-center text-primary">AppZanda</h1>
        
        <button id="toggleButton" class="bg-primary text-white p-2 rounded w-full mb-4">Datos del Partido</button>
        <div id="matchData" class="hidden">
            <!-- ... (mant√©n el contenido existente de matchData) ... -->
        </div>

        <div id="generalTimer" class="text-6xl font-bold mb-4">00:00:00</div>
        <div class="timer-controls flex justify-center space-x-4 mb-6">
            <button id="startButton" class="flex-1">‚ñ∂Ô∏è Iniciar</button>
            <button id="stopButton" class="flex-1">‚èπÔ∏è Detener</button>
            <button id="resetButton" class="flex-1">üîÑ Reiniciar</button>
        </div>
<!-- Contador de Jugadores Titulares -->
<div id="titularCount" class="text-xl font-bold my-4 text-center">
    Titulares: 0
</div>
        <div class="part-selector mb-4">
            <select id="partIndicator" class="w-full p-2 bg-gray-700 text-white rounded">
                <option value="1">1¬™ parte</option>
                <option value="2">2¬™ parte</option>
                <option value="3">Pr√≥rroga</option>
            </select>
        </div>

        <div class="overflow-x-auto mb-6">
            <table>
                <thead>
                    <tr>
                        <th>N¬∫</th>
                        <th>Jug</th>
                        <th>Pos</th>
                        <th>Minutos</th>
                        <th>Tit</th>
                        <th>GF</th>
                        <th>GC</th>
                        <th>AS</th>
                        <th>TA</th>
                        <th>TR</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="playerTable">
                    <!-- Players will be added here dynamically -->
                </tbody>
            </table>
        </div>

        <div class="flex flex-wrap -mx-2 mb-4">
            <div class="w-full md:w-1/3 px-2 mb-4">
                <input type="text" id="newPlayerName" class="w-full p-2 bg-gray-700 text-white rounded" placeholder="Jugador">
            </div>
            <div class="w-full md:w-1/3 px-2 mb-4">
                <input type="text" id="newPlayerDorsal" class="w-full p-2 bg-gray-700 text-white rounded" placeholder="Dorsal">
            </div>
            <div class="w-full md:w-1/3 px-2 mb-4">
                <select id="newPlayerPosition" class="w-full p-2 bg-gray-700 text-white rounded">
                    <option value="PO">PO</option>
                    <option value="LD">LD</option>
                    <option value="LI">LI</option>
                    <option value="CD">CD</option>
                    <option value="CI">CI</option>
                    <option value="CT">CT</option>
                    <option value="CAD">CAD</option>
                    <option value="CAI">CAI</option>
                    <option value="MCD">MCD</option>
                    <option value="MC">MC</option>
                    <option value="MP">MP</option>
                    <option value="ID">ID</option>
                    <option value="II">II</option>
                    <option value="ED">ED</option>
                    <option value="EI">EI</option>
                    <option value="DC">DC</option>
                </select>
            </div>
        </div>
        <button id="addPlayerButton" class="w-full bg-secondary text-white p-2 rounded mb-6">Agregar Jugador</button>

        <div class="flex flex-wrap -mx-2 mb-6">
            <div class="w-full md:w-1/2 px-2 mb-4">
                <input type="text" id="newColumnName" class="w-full p-2 bg-gray-700 text-white rounded" placeholder="Nombre de la columna">
            </div>
            <div class="w-full md:w-1/2 px-2">
                <button id="addColumnButton" class="w-full bg-primary text-white p-2 rounded">‚ûï A√±adir Columna</button>
            </div>
        </div>

        <div class="flex flex-wrap -mx-2 mb-6">
            <div class="w-full sm:w-1/2 md:w-1/4 px-2 mb-4">
                <button id="exportButton" class="w-full bg-green-500 text-white p-2 rounded">üì§ Exportar datos</button>
            </div>
            <div class="w-full sm:w-1/2 md:w-1/4 px-2 mb-4">
                <button id="importButton" class="w-full bg-orange-500 text-white p-2 rounded">üë• Importar Equipo</button>
                <input type="file" id="importFileInput" accept=".csv" style="display:none;">
            </div>
            <div class="w-full sm:w-1/2 md:w-1/4 px-2 mb-4">
                <button id="saveButton" class="w-full bg-blue-500 text-white p-2 rounded">üíæ Guardar Equipo</button>
            </div>
            <div class="w-full sm:w-1/2 md:w-1/4 px-2 mb-4">
                <button id="clearDataButton" class="w-full bg-red-500 text-white p-2 rounded">üóë Limpiar Datos</button>
            </div>
        </div>

        <button id="exportToGoogleSheetButton" class="w-full bg-yellow-500 text-white p-2 rounded mb-6">üìä Exportar a Google Sheet</button>

        <div class="chart-container">
            <canvas id="playerStatsChart"></canvas>
        </div>

        <!-- Tabla de Registro de Acciones -->
        <h2 class="text-2xl font-bold mt-8 mb-4">Registro de Acciones</h2>
        <div class="overflow-x-auto">
            <table id="actionLogTable" class="min-w-full bg-gray-800 border border-gray-700">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Jornada</th>
                        <th>Periodo</th>
                        <th>Minuto</th>
                        <th>Evento</th>
                        <th>Jugador</th>
                        <th>Dorsal</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Las entradas del registro se agregar√°n aqu√≠ din√°micamente -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Ingrese los datos del partido</h2>
            <form id="matchDataForm">
                <div class="mb-4">
                    <label for="teamLocal" class="block mb-2">Equipo Local:</label>
                    <input type="text" id="teamLocal" name="teamLocal" class="w-full p-2 bg-gray-700 text-white rounded">
                </div>
                <div class="mb-4">
                    <label for="teamVisitor" class="block mb-2">Equipo Visitante:</label>
                    <input type="text" id="teamVisitor" name="teamVisitor" class="w-full p-2 bg-gray-700 text-white rounded">
                </div>
                <div class="mb-4">
                    <label for="matchDate" class="block mb-2">Fecha:</label>
                    <input type="date" id="matchDate" name="matchDate" class="w-full p-2 bg-gray-700 text-white rounded">
                </div>
                <div class="mb-4">
                    <label for="matchTime" class="block mb-2">Hora:</label>
                    <input type="time" id="matchTime" name="matchTime" class="w-full p-2 bg-gray-700 text-white rounded">
                </div>
                <div class="mb-4">
                    <label for="matchRound" class="block mb-2">Jornada:</label>
                    <input type="text" id="matchRound" name="matchRound" class="w-full p-2 bg-gray-700 text-white rounded">
                </div>
                <button type="submit" id="saveDataButton" class="w-full bg-primary text-white p-2 rounded">Guardar Datos</button>
            </form>
        </div>
    </div>

        <script>
            let generalTimer;
            let isRunning = false;
            let generalTime = 0;
            const playerTimers = [];
            let startTime;
            let elapsedTime = 0;
            let timerInterval;
            let lastTime = Date.now(); // Almacena la √∫ltima hora cuando el cron√≥metro estaba activo

document.addEventListener("visibilitychange", function() {
    if (document.visibilityState === 'hidden') {
        lastTime = Date.now(); // Guarda el momento cuando la p√°gina va a segundo plano
    } else if (document.visibilityState === 'visible') {
        const currentTime = Date.now();
        const timeDifference = currentTime - lastTime; // Calcula la diferencia de tiempo

        // Verifica si los cron√≥metros deben ser actualizados
        if (isRunning) {
            generalTime += timeDifference; // Actualiza el tiempo general

            // Actualiza los cron√≥metros de cada jugador si est√°n activos
            playerTimers.forEach((timer, index) => {
                if (document.querySelectorAll('.status-button')[index].classList.contains('active')) {
                    timer.time += timeDifference;
                    // Actualiza el display del cron√≥metro para cada jugador
                    const playerTimerDisplay = document.querySelectorAll('.player-timer')[index];
                    playerTimerDisplay.textContent = new Date(timer.time).toISOString().substr(14, 9);
                }
            });

            // Actualiza el cron√≥metro general
            document.getElementById('generalTimer').textContent = new Date(generalTime).toISOString().substr(14, 9);
        }
    }
});
    

            document.getElementById('startButton').addEventListener('click', () => {
    if (!isRunning) {
        // Verifica si el cron√≥metro est√° en cero
        if (generalTime === 0) {
            const rows = document.querySelectorAll('#playerTable tr');
            rows.forEach(row => {
                const statusButton = row.querySelector('.status-button');
                const isTitular = statusButton.classList.contains('active');
                const dorsal = row.cells[0].textContent;
                const name = row.cells[1].textContent;
                const status = isTitular ? 'Titular' : 'Suplente';  // Determina el estado del jugador
                logEvent(status, name, dorsal, '00:00:000');
            });
        }

        // Iniciar el cron√≥metro
        isRunning = true;
        generalTimer = setInterval(() => {
            generalTime += 10;
            document.getElementById('generalTimer').textContent = new Date(generalTime).toISOString().substr(14, 9);
            playerTimers.forEach((player, index) => {
                const statusButton = document.querySelectorAll('.status-button')[index];
                if (statusButton.classList.contains('active')) {
                    player.time += 10;
                    document.querySelectorAll('.player-timer')[index].textContent = new Date(player.time).toISOString().substr(14, 9);
                }
            });
        }, 10);
    }
});

function logEvent(event, playerName, playerDorsal, time) {
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>${new Date().toISOString().slice(0, 10)}</td>
        <td>${document.getElementById('matchRound').value}</td>
        <td>${document.getElementById('partIndicator').value}</td>
        <td>${time}</td>
        <td>${event}</td>
        <td>${playerName}</td>
        <td>${playerDorsal}</td>
        <td><button onclick="removeLogRow(this)">üóëÔ∏è</button></td>
    `;
    document.getElementById('actionLogTable').querySelector('tbody').appendChild(newRow);
}



            document.getElementById('stopButton').addEventListener('click', () => {
                clearInterval(generalTimer);
                isRunning = false;
            });

            document.getElementById('resetButton').addEventListener('click', () => {
                clearInterval(generalTimer);
                isRunning = false;
                generalTime = 0;
                document.getElementById('generalTimer').textContent = '00:00:000';
            });

            function toggleStatus(button, index) {
    const isActive = button.classList.toggle('active');
    button.textContent = isActive ? 'Titular' : 'Suplente';

    if (isActive) {
        startPlayerTimer(index);
    } else {
        stopPlayerTimer(index);
    }
// Esperar un ciclo del evento para actualizar el conteo.
setTimeout(() => {
        updateTitularCount();
    }, 0); // Un retardo de 0 ms asegura que se ejecuta despu√©s de la actualizaci√≥n del DOM.
}



    function updateCounter(button, increment) {
    let currentValue = parseInt(button.textContent);
    currentValue += increment;
    button.textContent = currentValue;
    updateButtonColors();

    const row = button.closest('tr');
    const dorsal = row.children[0].textContent;
    const name = row.children[1].textContent;
    const actionIndex = button.closest('td').cellIndex; // Obt√©n el √≠ndice de la celda
    const action = document.querySelector('thead').querySelectorAll('th')[actionIndex].textContent;

    const matchDate = document.getElementById('matchDate').value;
    const matchRound = document.getElementById('matchRound').value;
    const periodo = document.getElementById('partIndicator').options[document.getElementById('partIndicator').selectedIndex].text;

    // Obtener minutos y segundos de generalTime
    let minutes = new Date(generalTime).getUTCMinutes();
    let seconds = new Date(generalTime).getUTCSeconds();

    // Formatear tiempo como "MM:SS"
    let formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;

    const logRow = document.createElement('tr');
    logRow.setAttribute('data-dorsal', dorsal); // Establece atributos para identificaci√≥n
    logRow.setAttribute('data-action-index', actionIndex); // Guarda el √≠ndice de la acci√≥n
    logRow.innerHTML = `
        <td>${matchDate}</td>
        <td>${matchRound}</td>
        <td>${periodo}</td>
        <td>${formattedTime}</td>
        <td>${action}</td>
        <td>${name}</td>
        <td>${dorsal}</td>
        <td>
            <button style="background-color: red; color: white;" onclick="removeLogRow(this)">-</button>
        </td>
    `;
    document.getElementById('actionLogTable').querySelector('tbody').appendChild(logRow);
}


function removeLogRow(button) {
    const logRow = button.closest('tr');
    const dorsal = logRow.getAttribute('data-dorsal');
    const actionIndex = logRow.getAttribute('data-action-index');

    // Encuentra la fila correspondiente en la tabla de jugadores y actualiza el contador
    const playerRows = document.querySelectorAll('#playerTable tr');
    playerRows.forEach(row => {
        if (row.children[0].textContent === dorsal) { // Compara el dorsal
            const counterCell = row.children[actionIndex];
            const counterButton = counterCell.querySelector('button');
            let count = parseInt(counterButton.textContent);
            if (count > 0) {
                counterButton.textContent = --count; // Decrementa el contador
                updateButtonColors();
            }
        }
    });

    logRow.remove(); // Elimina la fila del log
}


            function startDecrement(button) {
                button.holdInterval = setInterval(() => updateCounter(button, -1), 200);
            }

            function stopDecrement(button) {
                clearInterval(button.holdInterval);
            }

            document.getElementById('addPlayerButton').addEventListener('click', () => {
                const playerName = document.getElementById('newPlayerName').value;
                const playerDorsal = document.getElementById('newPlayerDorsal').value;
                const playerPosition = document.getElementById('newPlayerPosition').value;
                if (playerName && playerDorsal && playerPosition) {
                    const newRow = document.createElement('tr');
                    newRow.classList.add('titular-row');
                    newRow.innerHTML = `
                        <td class="py-2 px-2 border-b border-gray-700">${playerDorsal}</td>
                        <td class="py-2 px-2 border-b border-gray-700">${playerName}</td>
                        <td>
                <select onchange="updatePlayerPosition(this)" class="bg-gray-700 text-white rounded">
                    <option value="PO" ${playerPosition === "PO" ? "selected" : ""}>PO</option>
                    <option value="LD" ${playerPosition === "LD" ? "selected" : ""}>LD</option>
                    <option value="LI" ${playerPosition === "LI" ? "selected" : ""}>LI</option>
                    <option value="CD" ${playerPosition === "CD" ? "selected" : ""}>CD</option>
                    <option value="CI" ${playerPosition === "CI" ? "selected" : ""}>CI</option>
                    <option value="CT" ${playerPosition === "CT" ? "selected" : ""}>CT</option>
                    <option value="CAD" ${playerPosition === "CAD" ? "selected" : ""}>CAD</option>
                    <option value="CAI" ${playerPosition === "CAI" ? "selected" : ""}>CAI</option>
                    <option value="MCD" ${playerPosition === "MCD" ? "selected" : ""}>MCD</option>
                    <option value="MC" ${playerPosition === "MC" ? "selected" : ""}>MC</option>
                    <option value="MP" ${playerPosition === "MP" ? "selected" : ""}>MP</option>
                    <option value="ID" ${playerPosition === "ID" ? "selected" : ""}>ID</option>
                    <option value="II" ${playerPosition === "II" ? "selected" : ""}>II</option>
                    <option value="ED" ${playerPosition === "ED" ? "selected" : ""}>ED</option>
                    <option value="EI" ${playerPosition === "EI" ? "selected" : ""}>EI</option>
                    <option value="DC" ${playerPosition === "DC" ? "selected" : ""}>DC</option>
                </select>
            </td>
                        <td class="py-2 px-2 border-b border-gray-700 player-timer">00:00:000</td>
                        <td class="py-2 px-2 border-b border-gray-700">
                            <button class="status-button active" onclick="toggleStatus(this)">Titular</button>
                        </td>
                        <td class="py-2 px-2 border-b border-gray-700">
                            <button class="counter-button" style="background-color: black; color: white;" onclick="updateCounter(this, 1)" onmousedown="startDecrement(this)" onmouseup="stopDecrement(this)">0</button>
                        </td>
                        <td class="py-2 px-2 border-b border-gray-700">
                            <button class="counter-button" style="background-color: black; color: white;" onclick="updateCounter(this, 1)" onmousedown="startDecrement(this)" onmouseup="stopDecrement(this)">0</button>
                        </td>
                        <td class="py-2 px-2 border-b border-gray-700">
                            <button class="counter-button" style="background-color: black; color: white;" onclick="updateCounter(this, 1)" onmousedown="startDecrement(this)" onmouseup="stopDecrement(this)">0</button>
                        </td>
                        <td class="py-2 px-2 border-b border-gray-700">
                            <button class="counter-button ta-button" onclick="updateCounter(this, 1)" onmousedown="startDecrement(this)" onmouseup="stopDecrement(this)">0</button>
                        </td>
                        <td class="py-2 px-2 border-b border-gray-700">
                            <button class="counter-button tr-button" onclick="updateCounter(this, 1)" onmousedown="startDecrement(this)" onmouseup="stopDecrement(this)">0</button>
                        </td>
                        <td class="py-2 px-2 border-b border-gray-700">
                            <button style="background-color: orange; color: white; padding: 2px;" onclick="removeRow(this)">-</button>
                        </td>
                    `;
                    document.getElementById('playerTable').appendChild(newRow);
                    playerTimers.push({
                        time: 0,
                        interval: null
                    });
                    document.getElementById('newPlayerName').value = '';
                    document.getElementById('newPlayerDorsal').value = '';
                    document.getElementById('newPlayerPosition').value = '';
                    updateTitularCount(); // Aseg√∫rate de contar a los titulares despu√©s de agregar un nuevo jugador
                }
            });

            const positionPriority = {
                'PO': 1,
                'LD': 2,
                'LI': 3,
                'CD': 4,
                'CI': 5,
                'CT': 6,
                'CAD': 7,
                'CAI': 8,
                'MCD': 9,
                'MC': 10,
                'MP': 11,
                'ID': 12,
                'II': 13,
                'ED': 14,
                'EI': 15,
                'DC': 16
            };

            document.querySelectorAll('.status-button').forEach(button => {
                button.addEventListener('click', function () {
                    toggleStatus(this);
                    sortTable();
                });
            });

            document.getElementById('addColumnButton').addEventListener('click', () => {
                const columnName = document.getElementById('newColumnName').value;
                if (columnName) {
                    const headerRow = document.querySelector('thead tr');
                    const newHeader = document.createElement('th');
                    newHeader.classList.add('py-2', 'px-2', 'border-b', 'border-gray-700');
                    newHeader.textContent = columnName;
                    headerRow.insertBefore(newHeader, headerRow.children[headerRow.children.length - 1]);

                    const rows = document.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        const newCell = document.createElement('td');
                        newCell.classList.add('py-2', 'px-2', 'border-b', 'border-gray-700');
                        newCell.innerHTML = `
                            <button class="counter-button" style="background-color: black; color: white;" onclick="updateCounter(this, 1)" onmousedown="startDecrement(this)" onmouseup="stopDecrement(this)">0</button>
                        `;
                        row.insertBefore(newCell, row.children[row.children.length - 1]);
                    });

                    document.getElementById('newColumnName').value = '';
                }
            });

            document.querySelectorAll('th').forEach(th => {
                th.addEventListener('dblclick', () => {
                    const newName = prompt('Nuevo nombre de la columna:', th.textContent);
                    if (newName) {
                        th.textContent = newName;
                    }
                });
            });

            document.getElementById('exportButton').addEventListener('click', () => {
    const local = document.getElementById('teamLocal').value;
    const visitante = document.getElementById('teamVisitor').value;
    const fecha = document.getElementById('matchDate').value;
    const jornada = document.getElementById('matchRound').value;

    // Formatear el nombre del archivo con los valores de los campos
    const fileName = `${local}-${visitante},${jornada},${fecha}.csv`.replace(/\s+/g, '_').replace(/[:\/]/g, '-');

    // Preparar los datos para el CSV
    const headers = Array.from(document.querySelectorAll('thead th')).map(th => th.textContent.trim());
    const rows = Array.from(document.querySelectorAll('tbody tr')).map(row => {
        return Array.from(row.children).map(td => {
            const select = td.querySelector('select');
            const button = td.querySelector('button');
            if (select) {
                return select.value; // Usa el valor seleccionado del dropdown
            } else if (button) {
                return button.textContent.trim(); // Para botones u otros elementos interactivos
            } else {
                return td.textContent.trim(); // Para celdas de texto normal
            }
        }).join(",");
    });

    // Verificar que hay datos para exportar
    if (rows.length === 0) {
        alert('No hay datos para exportar.');
        return;
    }

    // Unir todo para el contenido del CSV
    const csvContent = [headers.join(",")].concat(rows).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});

let debounceTimer;
function updateTitularCountDebounced() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        updateTitularCount();
    }, 100); // Ajusta el tiempo de espera seg√∫n sea necesario
}

function updateTitularCount() {
    const activeButtons = document.querySelectorAll('.status-button.active');
    console.log("Botones activos:", activeButtons.length); // Depuraci√≥n
    const titularCount = activeButtons.length;
    document.getElementById('titularCount').textContent = `Titulares: ${titularCount}`;
}

function toggleStatus(button) {
    button.classList.toggle('active');
    button.textContent = button.classList.contains('active') ? 'Titular' : 'Suplente';
    // Disparar el evento para actualizar el conteo
    document.dispatchEvent(new CustomEvent('updateTitularCount'));
}

document.addEventListener('updateTitularCount', updateTitularCount);




            function updateButtonColors() {
                const taButtons = document.querySelectorAll('.ta-button');
                const trButtons = document.querySelectorAll('.tr-button');

                taButtons.forEach((button, index) => {
                    const taValue = parseInt(button.textContent);
                    const trButton = trButtons[index];
                    const trValue = parseInt(trButton.textContent);

                    if (taValue > 0) {
                        button.style.backgroundColor = 'yellow';
                    } else {
                        button.style.backgroundColor = '';
                    }

                    if (trValue > 0) {
                        trButton.style.backgroundColor = 'red';
                    } else {
                        trButton.style.backgroundColor = '';
                    }

                    if (taValue === 0 && trValue === 0) {
                        button.style.backgroundColor = 'black';
                        trButton.style.backgroundColor = 'black';
                    }
                });
            }

            document.addEventListener('DOMContentLoaded', () => {
                console.log("DOM fully loaded and parsed");
                updateTitularCount();
            });

            function updateTitularCount() {
    // Seleccionar todos los botones que tienen la clase 'active'.
    const activeButtons = document.querySelectorAll('.status-button.active');
    // Contar cu√°ntos botones activos existen.
    const titularCount = activeButtons.length;
    // Actualizar el contenido de alg√∫n elemento en tu HTML con el nuevo conteo.
    document.getElementById('titularCount').textContent = `Titulares: ${titularCount}`;
}


  // Aqu√≠ a√±ades el manejador de evento para asegurar que la cuenta se actualiza al cargar
  document.addEventListener('DOMContentLoaded', function() {
        updateTitularCount(); // Aseg√∫rate de contar los titulares al cargar la p√°gina
    });



            document.getElementById('saveButton').addEventListener('click', () => {
                const teamName = prompt('Ingrese el nombre del equipo:');
                if (teamName) {
                    const tableData = [];
                    const headers = ['N¬∫', 'Jug', 'Pos'];
                    tableData.push(headers);

                    const rows = document.querySelectorAll('#playerTable tr');
                    rows.forEach(row => {
                        const rowData = Array.from(row.children).slice(0, 3).map(td => td.textContent.trim());
                        tableData.push(rowData);
                    });

                    const csvContent = tableData.map(e => e.join(",")).join("\n");
                    const blob = new Blob([csvContent], {
                        type: 'text/csv;charset=utf-8;'
                    });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', `${teamName}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert('Nombre del equipo es requerido para guardar el archivo.');
                }
            });

            document.addEventListener('DOMContentLoaded', function () {
                var modal = document.getElementById('myModal');
                var btn = document.getElementById('toggleButton');
                var span = document.getElementsByClassName("close")[0];

                btn.onclick = function () {
                    modal.style.display = "block";
                }

                span.onclick = function () {
                    modal.style.display = "none";
                }

                window.onclick = function (event) {
                    if (event.target == modal) {
                        modal.style.display = "none";
                    }
                }
            });

            document.addEventListener('DOMContentLoaded', function () {
                const inputs = document.querySelectorAll("input[type='text'], input[type='date'], input[type='time']");
                inputs.forEach(input => {
                    if (localStorage.getItem(input.id)) {
                        input.value = localStorage.getItem(input.id);
                    }

                    input.addEventListener('input', () => {
                        localStorage.setItem(input.id, input.value);
                    });
                });

                const select = document.getElementById('partIndicator');
                if (localStorage.getItem('partIndicator')) {
                    select.value = localStorage.getItem('partIndicator');
                }
                select.addEventListener('change', () => {
                    localStorage.setItem('partIndicator', select.value);
                });
            });

            document.getElementById('clearDataButton').addEventListener('click', function () {
    // Pregunta al usuario si est√° seguro de querer limpiar los datos
    if (confirm('¬øEst√°s seguro de que deseas limpiar todos los datos?')) {
        localStorage.clear(); // Limpia todo el almacenamiento local
        const inputs = document.querySelectorAll("input[type='text'], input[type='date'], input[type='time'], select");
        
        // Se reinicia el valor de cada input y select
        inputs.forEach(input => {
            input.value = '';
        });
        document.getElementById('partIndicator').value = '1'; // Restablece este select en particular a un valor predeterminado
        
        // Recarga la p√°gina para reiniciar completamente cualquier estado o datos
        window.location.reload();
    } else {
        // Si el usuario no confirma, no hacer nada
        alert('Limpieza cancelada.');
    }
});



            function saveTableData() {
                const table = document.getElementById('playerTable');
                const data = [];
                Array.from(table.rows).forEach(row => {
                    const rowData = Array.from(row.cells).map(cell => {
                        const input = cell.querySelector('input');
                        const button = cell.querySelector('button');
                        if (input) {
                            return {
                                type: 'input',
                                value: input.value
                            };
                        } else if (button) {
                            return {
                                type: 'button',
                                text: button.textContent,
                                classList: Array.from(button.classList)
                            };
                        } else {
                            return {
                                type: 'text',
                                text: cell.textContent
                            };
                        }
                    });
                    data.push(rowData);
                });

                localStorage.setItem('playerData', JSON.stringify(data));
            }

            document.getElementById('addPlayerButton').addEventListener('click', function () {
                saveTableData();
            });

            function loadTableData() {
                const data = localStorage.getItem('playerData');
                if (data) {
                    const tableData = JSON.parse(data);
                    const table = document.getElementById('playerTable');
                    table.innerHTML = '';
                    tableData.forEach(rowData => {
                        const row = table.insertRow();
                        rowData.forEach(cellData => {
                            const cell = row.insertCell();
                            if (cellData.type === 'input') {
                                const input = document.createElement('input');
                                input.value = cellData.value;
                                cell.appendChild(input);
                            } else if (cellData.type === 'button') {
                                const button = document.createElement('button');
                                button.textContent = cellData.text;
                                button.classList.add(...cellData.classList);
                                button.addEventListener('click', function () {
                                    toggleStatus(this);
                                });
                                cell.appendChild(button);
                            } else if (cellData.type === 'text') {
                                cell.textContent = cellData.text;
                            }
                        });
                    });
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                loadTableData();
            });

            document.getElementById('importButton').addEventListener('click', () => {
    document.getElementById('importFileInput').click();
});

document.getElementById('importFileInput').addEventListener('change', handleFileSelect);

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const csvData = e.target.result;
            processCSVData(csvData);
        };
        reader.readAsText(file);
    }
}

function processCSVData(csvData) {
    const lines = csvData.split('\n');
    // Asumimos que la primera l√≠nea es el encabezado
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line) {  // Asegurarse de que la l√≠nea no est√© vac√≠a
            const [dorsal, name, position] = line.split(',');
            if (dorsal && name && position) {
                addPlayerToTable(dorsal.trim(), name.trim(), position.trim());
            }
        }
    }
}

function addPlayerToTable(dorsal, name, position) {
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>${dorsal}</td>
        <td>${name}</td>
        <td>
            <select onchange="updatePlayerPosition(this)" class="bg-gray-700 text-white rounded">
                <option value="PO" ${position === "PO" ? "selected" : ""}>PO</option>
                <option value="LD" ${position === "LD" ? "selected" : ""}>LD</option>
                <option value="LI" ${position === "LI" ? "selected" : ""}>LI</option>
                <option value="CD" ${position === "CD" ? "selected" : ""}>CD</option>
                <option value="CI" ${position === "CI" ? "selected" : ""}>CI</option>
                <option value="CT" ${position === "CT" ? "selected" : ""}>CT</option>
                <option value="CAD" ${position === "CAD" ? "selected" : ""}>CAD</option>
                <option value="CAI" ${position === "CAI" ? "selected" : ""}>CAI</option>
                <option value="MCD" ${position === "MCD" ? "selected" : ""}>MCD</option>
                <option value="MC" ${position === "MC" ? "selected" : ""}>MC</option>
                <option value="MP" ${position === "MP" ? "selected" : ""}>MP</option>
                <option value="ID" ${position === "ID" ? "selected" : ""}>ID</option>
                <option value="II" ${position === "II" ? "selected" : ""}>II</option>
                <option value="ED" ${position === "ED" ? "selected" : ""}>ED</option>
                <option value="EI" ${position === "EI" ? "selected" : ""}>EI</option>
                <option value="DC" ${position === "DC" ? "selected" : ""}>DC</option>
            </select>
        </td>
        <td class="player-timer">00:00:000</td>
        <td><button class="status-button active" onclick="toggleStatus(this)">Titular</button></td>
        <td><button class="counter-button" onclick="updateCounter(this, 1)">0</button></td>
        <td><button class="counter-button" onclick="updateCounter(this, 1)">0</button></td>
        <td><button class="counter-button" onclick="updateCounter(this, 1)">0</button></td>
        <td><button class="counter-button ta-button" onclick="updateCounter(this, 1)">0</button></td>
        <td><button class="counter-button tr-button" onclick="updateCounter(this, 1)">0</button></td>
        <td><button onclick="removeRow(this)">üóëÔ∏è</button></td>
    `;
    document.getElementById('playerTable').appendChild(newRow);
    playerTimers.push({ time: 0, interval: null });
    updateTitularCount();
}

document.getElementById('exportToGoogleSheetButton').addEventListener('click', function() {
    const playerTableData = [];
    const playerHeaders = Array.from(document.querySelectorAll('#playerTable thead th')).map(th => th.textContent);
    // A√±adir 'Match Round' como primera columna de los encabezados
    playerHeaders.unshift('Match Round');
    playerTableData.push(playerHeaders);

    const playerRows = document.querySelectorAll('#playerTable tr');
    playerRows.forEach(row => {
        const rowData = Array.from(row.children).map(td => {
            const selectElement = td.querySelector('select');
            if (selectElement) {
                return selectElement.value;
            } else {
                return td.textContent.trim();
            }
        });
        // A√±adir el valor de matchRound al principio de cada fila de datos
        rowData.unshift(document.getElementById('matchRound').value);
        playerTableData.push(rowData);
    });

    const actionLogData = [];
    const actionLogHeaders = Array.from(document.querySelectorAll('#actionLogTable thead th')).map(th => th.textContent);
    actionLogData.push(actionLogHeaders);

    const actionLogRows = document.querySelectorAll('#actionLogTable tbody tr');
    actionLogRows.forEach(row => {
        const rowData = Array.from(row.children).map(td => {
            const selectElement = td.querySelector('select');
            if (selectElement) {
                return selectElement.value;
            } else {
                return td.textContent.trim();
            }
        });
        actionLogData.push(rowData);
    });

    // Obtener los valores de los campos de entrada
    const teamLocal = document.getElementById('teamLocal').value;
    const teamVisitor = document.getElementById('teamVisitor').value;
    const matchDate = document.getElementById('matchDate').value;
    const matchTime = document.getElementById('matchTime').value;
    const matchRound = document.getElementById('matchRound').value;

    // Verifica que todos los campos est√©n completos
    if (!teamLocal || !teamVisitor || !matchDate || !matchTime || !matchRound) {
        alert('Por favor, completa todos los campos antes de enviar.');
        return;
    }

    const matchData = {
        teamLocal: teamLocal,
        teamVisitor: teamVisitor,
        matchDate: matchDate,
        matchTime: matchTime,
        matchRound: matchRound,
        playerTableData: playerTableData,
        actionLogData: actionLogData
    };

    // Realiza una solicitud POST al webhook de Make
    fetch('https://hook.eu2.make.com/kqow4a7hwp4tfm6mwjq2uj353a1mi637', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(matchData)
    })
    .then(response => {
        if(response.ok) {
            alert('Datos enviados con √©xito a Google Sheets!');
            return response.json();
        } else {
            response.text().then(text => {
                console.error('Error en la respuesta:', response.status, text);
                alert(`Algo sali√≥ mal al enviar los datos: ${response.status} - ${text}`);
            });
        }
    })
    .catch((error) => {
        console.error('Error en la solicitud:', error);
        alert('Error al enviar datos');
    });
});




document.getElementById('dataForm').addEventListener('submit', function(event) {
    event.preventDefault(); // Esto evita que el formulario se env√≠e de la manera tradicional
    saveData(); // Llama a la funci√≥n que maneja la l√≥gica para guardar datos
});

function saveData() {
    // Aqu√≠ puedes a√±adir la l√≥gica para guardar los datos, por ejemplo, almacenando en localStorage o enviando a un servidor via AJAX
    console.log("Datos guardados (simulado).");
}

function addPlayerRow(playerData) {
    const table = document.getElementById('playerTable');
    const row = table.insertRow();
    const cellTA = row.insertCell(8); // Asumiendo que TA es la novena celda (√≠ndice 8)

    cellTA.textContent = playerData.ta; // Suponiendo que playerData contiene un campo 'ta'
    cellTA.classList.add('ta-cell'); // Agrega la clase para identificaci√≥n f√°cil

    // A√±adir otras celdas...
    updateCellStyles(cellTA); // Actualiza el estilo de la celda TA directamente
}

function updateCellStyles(cell) {
    const value = parseInt(cell.textContent, 10);
    if (value > 0) {
        cell.style.backgroundColor = 'yellow';
    } else {
        cell.style.backgroundColor = '';
    }
}

let worker;
if (window.Worker) {
    worker = new Worker('timerWorker.js');
    worker.onmessage = function(e) {
        document.getElementById('generalTimer').textContent = new Date(e.data).toISOString().substr(14, 9);
    };
}

document.getElementById('startButton').addEventListener('click', function() {
    worker.postMessage('start');
});

document.getElementById('stopButton').addEventListener('click', function() {
    worker.postMessage('stop');
});

document.getElementById('resetButton').addEventListener('click', function() {
    worker.postMessage('reset');
    document.getElementById('generalTimer').textContent = '00:00:000';
});

function removeRow(button) {
    const row = button.closest('tr');
    row.remove();
}

function updatePlayerPosition(selectElement) {
    const row = selectElement.closest('tr');
    const playerDorsal = row.cells[0].textContent;
    const playerName = row.cells[1].textContent;
    const newPosition = selectElement.value;

    console.log(`Posici√≥n actualizada: ${playerName} (${playerDorsal}) ahora est√° en la posici√≥n ${newPosition}`);
    // Aqu√≠ puedes agregar m√°s l√≥gica si necesitas hacer algo m√°s con el cambio de posici√≥n
}

document.addEventListener('DOMContentLoaded', function() {
    initializePlayerTimers();
    updateTitularCount(); // Initialize titular count on page load
    loadTableData(); // Load saved table data
});

function initializePlayerTimers() {
    const playerRows = document.querySelectorAll('#playerTable tr');
    playerRows.forEach((row, index) => {
        const playerTimerCell = row.querySelector('.player-timer');
        const statusButton = row.querySelector('.status-button');
        playerTimers[index] = {
            time: 0,
            interval: null,
            timerCell: playerTimerCell,
            isActive: statusButton.classList.contains('active')
        };
    });
}

function startPlayerTimer(index) {
    const player = playerTimers[index];
    if (!player.isActive || player.interval) return;

    player.interval = setInterval(() => {
        player.time += 10;
        player.timerCell.textContent = formatTime(player.time);
    }, 10);
}

function stopPlayerTimer(index) {
    if (playerTimers[index] && playerTimers[index].interval) {
        clearInterval(playerTimers[index].interval);
        playerTimers[index].interval = null;
    } else {
        console.error('Intento de detener un temporizador no inicializado o ya detenido', index);
    }
}


function formatTime(time) {
        const date = new Date(time);
        const hours = Math.floor(time / 3600000);
        const minutes = date.getUTCMinutes();
        const seconds = date.getUTCSeconds();
        const milliseconds = date.getUTCMilliseconds();
        return `${(hours * 60 + minutes).toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}:${milliseconds.toString().padStart(3, '0')}`;
    }

document.querySelectorAll('.status-button').forEach((button, index) => {
    button.addEventListener('click', function() {
        toggleStatus(this, index); // Make sure the correct index is passed
    });
});

document.getElementById('playerTable').addEventListener('click', function(event) {
    // Verificar si el elemento clickeado o uno de sus padres tiene la clase `status-button`
    let target = event.target;
    while (target != this && !target.classList.contains('status-button')) {
        target = target.parentNode;
    }

    if (target.classList.contains('status-button')) {
        // Encontrar el √≠ndice de la fila en la que se encuentra el bot√≥n
        const rowIndex = Array.from(this.rows).indexOf(target.closest('tr'));
        // Llamar a toggleStatus pasando el bot√≥n y el √≠ndice correcto
        toggleStatus(target, rowIndex);
        // Llamar a sortTable para reordenar las filas despu√©s del cambio
        sortTable();
    }
});


function sortTable() {
  var table = document.getElementById("playerTable"); // Aseg√∫rate de que el ID es correcto
  var switching = true;
  var rows, i, x, y, shouldSwitch;

  // Repetir hasta que no haya intercambio
  while (switching) {
    switching = false; // Comienza suponiendo que no hay intercambio
    rows = table.rows;

    // Itera a trav√©s de todas las filas, excepto la primera que son los encabezados
    for (i = 1; i < (rows.length - 1); i++) {
      shouldSwitch = false;
      
      // Obtiene los elementos a comparar, en este caso, columna 'Titular' (index 4 asumido aqu√≠)
      x = rows[i].getElementsByTagName("TD")[4]; // Ajusta el √≠ndice seg√∫n tu tabla
      y = rows[i + 1].getElementsByTagName("TD")[4];
      
      // Comprueba si las dos filas deben intercambiarse, basado en el texto
      if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
        shouldSwitch = true;
        break;
      }

      // Si son iguales, considera la segunda columna 'Posici√≥n' (index 2 asumido)
      if (x.innerHTML.toLowerCase() === y.innerHTML.toLowerCase()) {
        x = rows[i].getElementsByTagName("TD")[2]; // Ajusta el √≠ndice seg√∫n tu tabla
        y = rows[i + 1].getElementsByTagName("TD")[2];
        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
          shouldSwitch = true;
          break;
        }
      }
    }

    // Si se determin√≥ que debe hacerse un intercambio, hazlo y marca que el intercambio ha sido hecho
    if (shouldSwitch) {
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
    }
  }
}

let timerWorker;

// Crear el Web Worker
if (window.Worker) {
  timerWorker = new Worker('timer-worker.js');
  timerWorker.onmessage = function(e) {
    updateDisplay(e.data.time);
  };
}

// Funci√≥n para iniciar el cron√≥metro
function startTimer() {
  if (!startTime) {
    startTime = Date.now() - elapsedTime;
  }
  timerInterval = requestAnimationFrame(updateTimer);
}

function stopTimer() {
  if (timerInterval) {
    cancelAnimationFrame(timerInterval);
    timerInterval = null;
  }
}

function resetTimer() {
  stopTimer();
  elapsedTime = 0;
  startTime = null;
  updateDisplay(0);
}

function updateTimer() {
  const currentTime = Date.now();
  elapsedTime = currentTime - startTime;
  updateDisplay(elapsedTime);
  timerInterval = requestAnimationFrame(updateTimer);
}

// Funci√≥n para actualizar la pantalla
function updateDisplay(timeInMilliseconds) {
        const totalSeconds = Math.floor(timeInMilliseconds / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        const milliseconds = timeInMilliseconds % 1000;

        const display = `${padZero(hours * 60 + minutes)}:${padZero(seconds)}:${padZero(milliseconds, 3)}`;
        document.getElementById('generalTimer').textContent = display;
    }

    function padZero(num, places = 2) {
        return String(num).padStart(places, '0');
    }

function padZero(num, places = 2) {
  return String(num).padStart(places, '0');
}

// Event listeners
document.querySelector('.timer-controls').addEventListener('click', (e) => {
  if (e.target.textContent.includes('Iniciar')) {
    startTimer();
  } else if (e.target.textContent.includes('Detener')) {
    stopTimer();
  } else if (e.target.textContent.includes('Reiniciar')) {
    resetTimer();
  }
});


        </script>
</body>

</html>



